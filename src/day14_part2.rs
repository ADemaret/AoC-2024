use std::time::Instant;

use crate::utils::grid2d::Grid2D;

// personal functions
//use crate::utils::grid2d;
use crate::utils::pause;
//use crate::utils::math;

pub fn main() {
    println!("-- Advent of Code - Day 14 - Part 2 --");
    let now = Instant::now();

    // let input = include_str!("../assets/day14_input_demo1.txt");
    let input = include_str!("../assets/day14_input.txt");

    if let Some(answer) = get_answer(input) {
        println!("The answer is : {}", answer);
    } else {
        println!("No answer found");
    }

    let elapsed1 = now.elapsed();
    println!("Elapsed: {:.2?}", elapsed1);
}

fn get_answer(input: &str) -> Option<usize> {
    for i in 0..10000 {
        if let Some(answer) = get_answer2(input, i) {
            if answer == 81 {
                return Some(i as usize);
            }
        }
    }
    None
}

//

fn get_answer2(input: &str, secondes: i64) -> Option<usize> {
    // let secondes = 100;
    // let grid_x = 11;
    // let grid_y = 7;
    let grid_x = 101;
    let grid_y = 103;

    // input
    let bots = input
        .lines()
        .map(|line| {
            line.split(['=', ',', ' '])
                .filter_map(|a| a.parse::<i64>().ok())
                .collect::<Vec<_>>()
        })
        .collect::<Vec<_>>();

    // final position
    let mut finals = Vec::new();
    for bot in bots {
        let x =
            (((bot[0] + grid_x) % grid_x + ((bot[2] + grid_x) % grid_x) * secondes + 3 * grid_x)
                % grid_x) as usize;
        let y =
            (((bot[1] + grid_y) % grid_y + ((bot[3] + grid_y) % grid_y) * secondes + 3 * grid_y)
                % grid_y) as usize;
        finals.push((y, x));
    }

    // grid for debug
    let grid = Grid2D::new(
        ".......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
.......................................................................................................
");

    // search for a 9x9 black zone
    for zzx in 0..grid_x - 9 {
        for zzy in 0..grid_y - 9 {
            let result = quadrant(
                &finals,
                zzx as usize,
                (zzx + 9) as usize,
                zzy as usize,
                (zzy + 9) as usize,
            );
            if result == 81 {
                grid.print_with_vec(&finals, 'x');
                return Some(result);
            }
        }
    }

    None
}

fn quadrant(
    finals: &Vec<(usize, usize)>,
    x_min: usize,
    x_max: usize,
    y_min: usize,
    y_max: usize,
) -> usize {
    // println!("{}<=x<={}, {}<=y<={}",x_min,x_max,y_min,y_max);
    let mut result = 0;
    for f in finals {
        if f.1 >= x_min && f.1 <= x_max && f.0 >= y_min && f.0 <= y_max {
            // println!("{:?}",f);
            result += 1;
        }
    }
    result
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_total() {
        // assert_eq!(
        //     get_answer(include_str!("../assets/day14_input_demo1.txt")),
        //     None
        // );
        assert_eq!(
            get_answer(include_str!("../assets/day14_input.txt")),
            Some(6398)
        );
    }
}
